# CineBoard - Cursor Rules
# Version: 2.0
# Date: January 28, 2026

## Project Identity

CineBoard is the **AI Film Operating System** — the persistent memory of your AI film.

**Core Principle:**
> CineBoard non genera, non interpreta, non riscrive.
> Organizza, conserva, rende trasportabile.

## Architecture

```
PROJECT
├── ENTITIES (canon)
│   ├── Character
│   ├── Environment
│   └── Asset
├── SHOTLIST (optional)
│   └── SHOTS (narrative nodes)
│       └── Board workspace (0:1)
│           └── TAKES (production variants)
├── BOARDS (creative canvas)
│   ├── Free
│   ├── Source (1:N Entity)
│   └── Workspace (1:1 Entity/Shot)
└── TEMPLATES (reusable structures)
```

## Code Patterns

### File Locations
- Server Actions: `src/app/actions/`
- Query Functions: `src/lib/db/queries/`
- Types: `src/lib/db/schema.ts` (Supabase generated)
- UI Components: `src/components/`
- Pages: `src/app/` (App Router)

### NO Barrel Files
- Import directly: `import { fn } from '@/lib/db/queries/entities'`
- Never create `index.ts` for exports

### Server Action Pattern
```typescript
'use server'
import { revalidatePath } from 'next/cache'

export async function createAction(parentId: string, formData: FormData) {
  // 1. Parse formData
  // 2. Call query function
  // 3. revalidatePath
  // 4. Return { id } (no redirect on create)
}
```

### Query Function Pattern
```typescript
import { createClient } from '@/lib/supabase/server'
import { Database } from '@/lib/db/schema'

type Resource = Database['public']['Tables']['resources']['Row']

export async function getResource(id: string): Promise<Resource | null> {
  const supabase = await createClient()
  const { data, error } = await supabase.from('resources').select('*').eq('id', id).single()
  if (error && error.code !== 'PGRST116') throw new Error(error.message)
  return data
}
```

### Page Component Pattern
```typescript
interface PageProps {
  params: { id: string }  // NOT Promise, direct object
}

export default async function Page({ params }: PageProps) {
  const { id } = params
  // fetch data, render
}
```

## Vocabulary (Film-First)

Use cinematographic terms:
- **Entity** = canonical character/environment/asset
- **Shot** = narrative node (NOT generation)
- **Take** = production variant (only in Shot Board)
- **Board** = creative workspace
- **Crystallize** = turn Board content into Entity/Shot

Avoid generic terms:
- ❌ "module", "card", "item", "block"
- ✅ "Shot", "Entity", "Take", "Board Node"

## Non-Negotiable Principles

1. **Board is always free** — no imposed type
2. **Entity is canon** — master_prompt + reference_images
3. **Shot is narrative** — no generation data
4. **Take only for Shot** — Entity has no Takes
5. **Export is foundational** — no lock-in
6. **Templates are structure** — no canonical content
7. **Nothing overwritten** — only superseded in time

## Database

- RLS enabled on all tables
- Permissive policies during development
- FK with CASCADE delete
- Triggers for updated_at
- JSONB for flexible data (entity_references)

## Commands

```bash
# Development
npm run dev

# TypeScript check
npx tsc --noEmit

# Clear cache if errors
rm -rf .next

# Supabase
npx supabase migration list
npx supabase db push
npx supabase gen types typescript --project-id [id] > src/lib/db/schema.ts
```

## Current Status

### Complete
- Projects CRUD
- Entities v1 (Character/Environment/Asset)
- Shotlist + Shots
- Entity ↔ Shot cross-navigation
- Board Conceptual Design v2.0 FINAL

### Next
- Board implementation (schema, queries, UI)
- Takes
- Export

## Key Files

- `BOARD_CONCEPTUAL_DESIGN.md` — Source of truth for Board architecture
- `FEATURE_SPECS_v2.0.md` — Feature specifications
- `ROADMAP_v2.0.md` — Development timeline
- `TECH_STACK_v2.0.md` — Technical decisions
